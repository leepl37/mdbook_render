#### 2.2.2.4. BLE

신분증앱과 응대장치가 물리적으로 가까운 거리에 있고, BLE로 정보를 송수신하는 경우에 대하여 설명한다. 모드는 아래 두 가지가 있다.

|            모드             |                  설명                  |                            장치의 온라인 여부                            |
| -------------------------- | ------------------------------------- | ---------------------------------------------------------------------- |
| BLE + QR-MPM indirect mode | 응대장치가 QR을 표출하고 BLE 연결을 대기 | - 신분증앱: 온라인<br>- 응대장치: 온라인                                  |
| BLE + QR-CPM indirect mode | 신분증앱이 QR을 표출하고 BLE 연결을 대기 | - 신분증앱: <span style="color:red">오프라인</span><br>- 응대장치: 온라인 |

대부분의 상황에서는 신분증앱이 인터넷에 연결된 상태이므로 `BLE + QR-MPM` 방식의 사용을 권장한다.

##### 2.2.2.4.1. 공통
[메시지]

절차 설명에 나타나는 `password`, `profile` 등의 메시지는 **6.1. BLE 인터페이스 메시지**를 참조한다. 중계서버 메시지와 형식은 유사하나 같은 것이 아님을 유의하여야 한다. 이러한 이유로 <u>BLE + QR 모드에서는 M200 메시지는 사용되지 않는다</u>.

[메시지 전송]

각 메시지 전송 시에는 메시지의 끝을 알리기 위한 고유 문자열 "/EOM/"을 첨부한다. 아래는 그 예시이다.

|       신분증앱        |            응대장치            |
| -------------------- | ----------------------------- |
|                      | ← {"msg":"password",...}/EOM/ |
| {"msg":"ack"}/EOM/ → |                               |


[가능한 오류 목록]

오류 발생 시 `error` 메시지에 오류정보를 담아 전송한다.

| 오류코드<br>(10진수) |        이름         |        설명        |         비고          |
| ------------------- | ------------------ | ------------------ | -------------------- |
| 10501               | incorrect password | BLE 비밀번호 불일치 | 응대장치에서 오류 발생 |
| 20501               | incorrect password | BLE 비밀번호 불일치 | 신분증앱에서 오류 발생 |

##### 2.2.2.4.2. BLE + QR-MPM indirect mode

[절차 요약]
1. 응대장치가 `bleid`, `blepw` 생성하여 QR 표출하고 연결 대기
    * bleid: UUID 형식으로 매번 다른 값을 생성
    * blepd: 10자리의 hexa-decimal 스트링
2. 신분증앱이 QR을 스캔하여 정보획득
3. 신분증앱이 `bleid`로 장치 스캔하여 연결
4. BLE 인터페이스 메시지 형식에 맞게 메시지 송수신
5. 거래 종료

[절차 상세]
<img src=./e877a1309fe3014c4db8ab8858bb80e7.svg>


##### 2.2.2.4.3. BLE + QR-CPM indirect mode
[절차 요약]
1. 신분증앱이 `bleid`, `blepw` 생성하여 QR 표출하고 연결 대기
    * bleid: UUID 형식으로 매번 다른 값을 생성
    * blepd: 10자리의 hexa-decimal 스트링
2. 응대장치가 QR을 스캔하여 정보획득
3. 응대장치가 `bleid`로 장치 스캔하여 연결
4. BLE 인터페이스 메시지 형식에 맞게 메시지 송수신
5. 거래 종료

[절차 상세]
<img src=./9b79df5e11d6afc93ca696dc3b9d32c8.svg>



